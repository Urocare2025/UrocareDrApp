<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Patient Records â€” Easy Entry</title>
  <style>
    :root { --bg: #f6f8fb; --card: #ffffff; --accent: #0b63ff; --muted: #6b7280; --danger: #ef4444; --radius: 12px; }
    body { font-family: system-ui, sans-serif; margin: 18px; background: var(--bg); color: #111; }
    .wrap { max-width: 980px; margin: 18px auto; }
    .card { background: var(--card); border-radius: var(--radius); padding: 14px; box-shadow: 0 6px 18px rgba(15,23,42,0.06); margin-bottom: 12px; }
    input, select { width: 100%; padding: 9px; border: 1px solid #e6e9ef; border-radius: 8px; box-sizing: border-box; font-size: 14px; margin-bottom: 8px; }
    .buttons { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
    button { background: var(--accent); color: white; padding: 10px 12px; border-radius: 10px; border: 0; font-weight: 600; cursor: pointer; }
    button.secondary { background: #e2e8f0; color: #475569; }
    button.danger { background: var(--danger); }
    button.paid { background: #dc2626; }
    tr.paid-row { background-color: #fee2e2 !important; }
    table { width: 100%; border-collapse: collapse; margin-top: 14px; font-size: 14px; }
    th, td { padding: 8px; border-bottom: 1px solid #eef2f6; text-align: left; }
    .actions button { margin-right: 6px; padding: 4px 8px; font-size: 12px; }
    #importInput { display: none; }
    #paidArea { display: none; background: #fff5f5; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #fed7d7; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div id="form">
        <input id="date" type="date" />
        <input id="patient_name" placeholder="Patient name" />
        <input id="hospital" placeholder="Hospital" />
        <select id="type">
          <option value="OPD">OPD</option>
          <option value="IPD">IPD</option>
          <option value="Operation">Operation</option>
        </select>
        <input id="procedure_name" placeholder="Procedure name" />
        <input id="fees" type="number" placeholder="Fees" />
        <input id="other_expenses" type="number" placeholder="Other expenses" />
        <input id="other_payee" placeholder="Other payee" />
        
        <div id="paidArea">
          <input type="checkbox" id="paidCheckbox" style="width:auto;"> 
          <label for="paidCheckbox" style="font-weight:bold; color:#c53030;"> Payment Received (Paid)</label>
        </div>
      </div>
      <div class="buttons">
        <button id="saveBtn">Save record</button>
        <button class="secondary" onclick="exportCsv()">Export CSV</button>
        <button class="secondary" onclick="document.getElementById('importInput').click()">Import CSV</button>
        <input type="file" id="importInput" accept=".csv" onchange="importCsv(event)">
        <button class="secondary" onclick="clearAll()">Clear All Records</button>
        <button class="danger" id="cancelBtn" style="display:none" onclick="cancelEdit()">Cancel Edit</button>
      </div>
    </div>

    <div class="card">
      <table id="tbl">
        <thead>
          <tr>
            <th>ID</th><th>Date</th><th>Patient</th><th>Hospital</th><th>Type</th><th>Fees</th><th>Other</th><th>Paid?</th><th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'patient_records_v1';
    let records = [];
    let editingId = null;

    // INITIAL LOAD: Cleans your old data automatically
    function init() {
      const rawData = localStorage.getItem(STORAGE_KEY);
      if (rawData) {
        records = JSON.parse(rawData).map(r => {
          // Force convert any old "Yes"/"No" strings into true booleans
          if (r.paid === "Yes" || r.paid === "true" || r.paid === true) r.paid = true;
          else r.paid = false;
          return r;
        });
      }
      render();
    }

    function render() {
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';
      records.sort((a,b) => b.id - a.id); // Show newest at top

      records.forEach(r => {
        const isPaid = (r.paid === true);
        const tr = document.createElement('tr');
        if (isPaid) tr.classList.add('paid-row');
        
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${r.date || ''}</td>
          <td>${r.patient_name || ''}</td>
          <td>${r.hospital || ''}</td>
          <td>${r.type || ''}</td>
          <td>${r.fees || 0}</td>
          <td>${r.other_expenses || 0}</td>
          <td style="font-weight:bold; color:${isPaid ? 'green' : 'red'}">${isPaid ? 'YES' : 'No'}</td>
          <td class="actions">
            <button onclick="editItem(${r.id})">Edit</button>
            ${!isPaid ? `<button class="paid" onclick="markPaid(${r.id})">Mark Paid</button>` : ''}
            <button class="danger" onclick="deleteItem(${r.id})">Del</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    }

    function saveOrUpdateRecord() {
      const isPaid = editingId ? document.getElementById('paidCheckbox').checked : false;
      
      const rec = {
        id: editingId || Date.now(),
        date: document.getElementById('date').value,
        patient_name: document.getElementById('patient_name').value.trim(),
        hospital: document.getElementById('hospital').value.trim(),
        type: document.getElementById('type').value,
        procedure_name: document.getElementById('procedure_name').value.trim(),
        fees: document.getElementById('fees').value || 0,
        other_expenses: document.getElementById('other_expenses').value || 0,
        other_payee: document.getElementById('other_payee').value.trim(),
        paid: isPaid // This is now a clean True/False
      };

      if (editingId) {
        const idx = records.findIndex(r => r.id === editingId);
        records[idx] = rec;
      } else {
        records.push(rec);
      }
      
      cancelEdit();
      render();
    }

    function editItem(id) {
      editingId = id;
      const r = records.find(rec => rec.id === id);
      document.getElementById('date').value = r.date;
      document.getElementById('patient_name').value = r.patient_name;
      document.getElementById('hospital').value = r.hospital;
      document.getElementById('type').value = r.type;
      document.getElementById('procedure_name').value = r.procedure_name;
      document.getElementById('fees').value = r.fees;
      document.getElementById('other_expenses').value = r.other_expenses;
      document.getElementById('other_payee').value = r.other_payee;
      
      document.getElementById('paidCheckbox').checked = (r.paid === true);
      document.getElementById('paidArea').style.display = 'block';
      document.getElementById('cancelBtn').style.display = 'inline-block';
      document.getElementById('saveBtn').textContent = 'Update Record';
    }

    function markPaid(id) {
      const idx = records.findIndex(r => r.id === id);
      records[idx].paid = true;
      render();
    }

    function deleteItem(id) {
      if(confirm("Delete this record?")) {
        records = records.filter(r => r.id !== id);
        render();
      }
    }

    function exportCsv() {
      if (records.length === 0) return alert("No records to export.");
      const headers = ['id','date','patient_name','hospital','type','procedure_name','fees','other_expenses','other_payee','paid'];
      let csvContent = headers.join(',') + '\n';
      
      records.forEach(r => {
        let row = headers.map(h => {
          let val = r[h];
          if (h === 'paid') val = (r.paid === true) ? 'Yes' : 'No';
          return `"${String(val || '').replace(/"/g, '""')}"`;
        });
        csvContent += row.join(',') + '\n';
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `patient_data_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    function importCsv(event) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const lines = e.target.result.split('\n').filter(l => l.trim() !== "");
        const imported = [];
        for (let i = 1; i < lines.length; i++) {
          const cols = lines[i].split(',').map(c => c.replace(/"/g, '').trim());
          if (cols.length < 10) continue;
          imported.push({
            id: Number(cols[0]) || Date.now() + i,
            date: cols[1],
            patient_name: cols[2], hospital: cols[3], type: cols[4], procedure_name: cols[5],
            fees: cols[6], other_expenses: cols[7], other_payee: cols[8],
            paid: (cols[9].toLowerCase() === 'yes' || cols[9] === 'true')
          });
        }
        records = imported;
        render();
        alert("Import successful. Old browser data cleaned.");
      };
      reader.readAsText(event.target.files[0]);
    }

    function clearAll() { if(confirm("This will delete ALL records. Continue?")) { records = []; render(); } }
    
    function cancelEdit() { 
      editingId = null; 
      document.querySelectorAll('#form input').forEach(i => i.value = '');
      document.getElementById('paidArea').style.display = 'none';
      document.getElementById('cancelBtn').style.display = 'none';
      document.getElementById('saveBtn').textContent = 'Save Record';
    }

    document.getElementById('saveBtn').addEventListener('click', saveOrUpdateRecord);
    init(); // Run the cleaner on startup
  </script>
</body>
</html>